From 3452303e7eadac07cb91e371370d0661bef068ff Mon Sep 17 00:00:00 2001
From: Xiao-Long Chen <chenxiaolong@cxl.epac.to>
Date: Fri, 31 Jan 2014 13:27:50 -0500
Subject: [PATCH] Telephony: Add settings for forward and reverse number lookup

Change-Id: I96d5b4a455095b40cf25ee39f5cba9fe16e11832
---
 Android.mk                                     |  14 +++
 AndroidManifest.xml                            |   4 +
 res/values/array.xml                           |  26 ++++
 res/values/cm_strings.xml                      |  10 ++
 res/xml/call_feature_setting.xml               |  33 +++++
 src/com/android/phone/CallFeaturesSetting.java | 160 +++++++++++++++++++++++++
 6 files changed, 247 insertions(+)

diff --git a/Android.mk b/Android.mk
index b12d32e..16bc4da 100644
--- a/Android.mk
+++ b/Android.mk
@@ -8,6 +8,7 @@ LOCAL_JAVA_LIBRARIES := telephony-common voip-common
 LOCAL_STATIC_JAVA_LIBRARIES := com.android.phone.shared \
         com.android.services.telephony.common \
         guava \
+        gservices
 
 LOCAL_SRC_FILES := $(call all-java-files-under, src)
 LOCAL_SRC_FILES += \
@@ -15,6 +16,14 @@ LOCAL_SRC_FILES += \
         src/com/android/phone/INetworkQueryService.aidl \
         src/com/android/phone/INetworkQueryServiceCallback.aidl
 
+# Include Google Play Services
+gservices_res := ../../../external/google/google_play_services/libproject/google-play-services_lib/res
+LOCAL_RESOURCE_DIR := $(addprefix $(LOCAL_PATH)/, $(gservices_res) res)
+
+LOCAL_AAPT_FLAGS := \
+    --auto-add-overlay \
+    --extra-packages com.google.android.gms
+
 LOCAL_PACKAGE_NAME := TeleService
 
 LOCAL_CERTIFICATE := platform
@@ -24,5 +33,10 @@ LOCAL_PROGUARD_FLAG_FILES := proguard.flags
 
 include $(BUILD_PACKAGE)
 
+include $(CLEAR_VARS)
+LOCAL_PREBUILT_STATIC_JAVA_LIBRARIES := \
+    gservices:../../../external/google/google_play_services/libproject/google-play-services_lib/libs/google-play-services.jar
+include $(BUILD_MULTI_PREBUILT)
+
 # Build the test package
 include $(call all-makefiles-under,$(LOCAL_PATH))
diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index ecca593..24ee15b 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -110,6 +110,10 @@
                       android:readPermission="android.permission.READ_CONTACTS"
                       android:writePermission="android.permission.WRITE_CONTACTS" />
 
+        <meta-data
+            android:name="com.google.android.gms.version"
+            android:value="@integer/google_play_services_version" />
+
         <!-- Workaround for non saved phone number -->
         <receiver android:name=".MyPhoneNumber">
             <intent-filter>
diff --git a/res/values/array.xml b/res/values/array.xml
index 245c09b..f334858 100644
--- a/res/values/array.xml
+++ b/res/values/array.xml
@@ -49,4 +49,30 @@
         <item>@string/sip_always_send_keepalive</item>
     </string-array>
 
+    <string-array translatable="false" name="forward_lookup_providers">
+        <item>Google</item>
+        <item>OpenStreetMap</item>
+    </string-array>
+
+    <string-array translatable="true" name="forward_lookup_provider_names">
+        <item>Google</item>
+        <item>OpenStreetMap</item>
+    </string-array>
+
+    <string-array translatable="false" name="reverse_lookup_providers">
+        <item>Google</item>
+        <item>OpenCnam</item>
+        <item>WhitePages</item>
+        <item>YellowPages</item>
+        <item>ZabaSearch</item>
+    </string-array>
+
+    <string-array translatable="true" name="reverse_lookup_provider_names">
+        <item>Google (Businesses)</item>
+        <item>OpenCnam (US)</item>
+        <item>WhitePages (US)</item>
+        <item>YellowPages (US)</item>
+        <item>ZabaSearch (US)</item>
+    </string-array>
+
 </resources>
diff --git a/res/values/cm_strings.xml b/res/values/cm_strings.xml
index bad9646..f671dbd 100644
--- a/res/values/cm_strings.xml
+++ b/res/values/cm_strings.xml
@@ -84,4 +84,14 @@
     <!-- Noise suppression -->
     <string name="noise_suppression_title">Noise suppression</string>
     <string name="noise_suppression_summary">Enable noise suppression for calls</string>
+
+    <!-- Number lookup -->
+    <string name="number_lookup">Phone number lookup</string>
+    <string name="enable_forward_lookup_title">Enable forward lookup</string>
+    <string name="enable_forward_lookup_summary">Show nearby places when searching in the dialer</string>
+    <string name="enable_reverse_lookup_title">Enable reverse lookup</string>
+    <string name="enable_reverse_lookup_summary">Look up information about the person or place for unknown numbers on incoming calls</string>
+    <string name="choose_lookup_providers">Choose lookup providers</string>
+    <string name="choose_forward_lookup_provider_title">Choose forward lookup provider</string>
+    <string name="choose_reverse_lookup_provider_title">Choose reverse lookup provider</string>
 </resources>
diff --git a/res/xml/call_feature_setting.xml b/res/xml/call_feature_setting.xml
index 7913365..c913d7d 100644
--- a/res/xml/call_feature_setting.xml
+++ b/res/xml/call_feature_setting.xml
@@ -63,6 +63,39 @@
   </PreferenceCategory>
 
   <PreferenceCategory
+      android:title="@string/number_lookup" />
+
+  <SwitchPreference
+      android:key="switch_enable_forward_lookup"
+      android:title="@string/enable_forward_lookup_title"
+      android:summary="@string/enable_forward_lookup_summary"
+      android:defaultValue="false"
+      android:persistent="false" />
+
+  <SwitchPreference
+      android:key="switch_enable_reverse_lookup"
+      android:title="@string/enable_reverse_lookup_title"
+      android:summary="@string/enable_reverse_lookup_summary"
+      android:defaultValue="false"
+      android:persistent="false" />
+
+  <PreferenceScreen
+      android:title="@string/choose_lookup_providers"
+      android:persistent="false">
+
+      <ListPreference
+          android:key="button_choose_forward_lookup_provider"
+          android:title="@string/choose_forward_lookup_provider_title"
+          android:persistent="false" />
+
+      <ListPreference
+          android:key="button_choose_reverse_lookup_provider"
+          android:title="@string/choose_reverse_lookup_provider_title"
+          android:persistent="false" />
+
+  </PreferenceScreen>
+
+  <PreferenceCategory
       android:key="button_misc_category_key"
       android:title="@string/other_settings"
       android:persistent="false" />
diff --git a/src/com/android/phone/CallFeaturesSetting.java b/src/com/android/phone/CallFeaturesSetting.java
index 7a07618..c5715ac 100644
--- a/src/com/android/phone/CallFeaturesSetting.java
+++ b/src/com/android/phone/CallFeaturesSetting.java
@@ -50,6 +50,7 @@ import android.preference.PreferenceActivity;
 import android.preference.PreferenceGroup;
 import android.preference.PreferenceManager;
 import android.preference.PreferenceScreen;
+import android.preference.SwitchPreference;
 import android.provider.ContactsContract.CommonDataKinds;
 import android.provider.MediaStore;
 import android.provider.Settings;
@@ -72,6 +73,11 @@ import com.android.internal.telephony.cdma.TtyIntent;
 import com.android.internal.telephony.util.BlacklistUtils;
 import com.android.phone.sip.SipSharedPreferences;
 
+import com.google.android.gms.common.ConnectionResult;
+import com.google.android.gms.common.GooglePlayServicesUtil;
+
+import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.Collection;
 import java.util.HashMap;
 import java.util.HashSet;
@@ -199,6 +205,15 @@ public class CallFeaturesSetting extends PreferenceActivity
     private static final String SIP_SETTINGS_CATEGORY_KEY =
             "sip_settings_category_key";
 
+    private static final String SWITCH_ENABLE_FORWARD_LOOKUP =
+            "switch_enable_forward_lookup";
+    private static final String SWITCH_ENABLE_REVERSE_LOOKUP =
+            "switch_enable_reverse_lookup";
+    private static final String BUTTON_CHOOSE_FORWARD_LOOKUP_PROVIDER =
+            "button_choose_forward_lookup_provider";
+    private static final String BUTTON_CHOOSE_REVERSE_LOOKUP_PROVIDER =
+            "button_choose_reverse_lookup_provider";
+
     private Intent mContactListIntent;
 
     /** Event for Async voicemail change call */
@@ -289,6 +304,10 @@ public class CallFeaturesSetting extends PreferenceActivity
     private CheckBoxPreference mVoicemailNotificationVibrate;
     private SipSharedPreferences mSipSharedPreferences;
     private PreferenceScreen mButtonBlacklist;
+    private SwitchPreference mEnableForwardLookup;
+    private SwitchPreference mEnableReverseLookup;
+    private ListPreference mChooseForwardLookupProvider;
+    private ListPreference mChooseReverseLookupProvider;
 
     private class VoiceMailProvider {
         public VoiceMailProvider(String name, Intent intent) {
@@ -617,6 +636,12 @@ public class CallFeaturesSetting extends PreferenceActivity
             }
         } else if (preference == mButtonSipCallOptions) {
             handleSipCallOptionsChange(objValue);
+        } else if (preference == mEnableForwardLookup
+                || preference == mEnableReverseLookup) {
+            saveLookupProviderSwitches(preference, (Boolean) objValue);
+        } else if (preference == mChooseForwardLookupProvider
+                || preference == mChooseReverseLookupProvider) {
+            saveLookupProviders(preference, (String) objValue);
         }
         // always let the preference setting proceed.
         return true;
@@ -1659,6 +1684,27 @@ public class CallFeaturesSetting extends PreferenceActivity
             }
         }
 
+        mEnableForwardLookup = (SwitchPreference)
+                findPreference(SWITCH_ENABLE_FORWARD_LOOKUP);
+        mEnableReverseLookup = (SwitchPreference)
+                findPreference(SWITCH_ENABLE_REVERSE_LOOKUP);
+
+        mEnableForwardLookup.setOnPreferenceChangeListener(this);
+        mEnableReverseLookup.setOnPreferenceChangeListener(this);
+
+        restoreLookupProviderSwitches();
+
+        mChooseForwardLookupProvider = (ListPreference)
+                findPreference(BUTTON_CHOOSE_FORWARD_LOOKUP_PROVIDER);
+        mChooseReverseLookupProvider = (ListPreference)
+                findPreference(BUTTON_CHOOSE_REVERSE_LOOKUP_PROVIDER);
+
+        mChooseForwardLookupProvider.setOnPreferenceChangeListener(this);
+        mChooseReverseLookupProvider.setOnPreferenceChangeListener(this);
+
+        initLookupProviders();
+        restoreLookupProviders();
+
         // create intent to bring up contact list
         mContactListIntent = new Intent(Intent.ACTION_GET_CONTENT);
         mContactListIntent.setType(android.provider.Contacts.Phones.CONTENT_ITEM_TYPE);
@@ -1861,6 +1907,9 @@ public class CallFeaturesSetting extends PreferenceActivity
 
         lookupRingtoneName();
         updateBlacklistSummary();
+
+        restoreLookupProviderSwitches();
+        restoreLookupProviders();
     }
 
     private void updateBlacklistSummary() {
@@ -2013,6 +2062,117 @@ public class CallFeaturesSetting extends PreferenceActivity
         }
     }
 
+    private void saveLookupProviderSwitches(Preference pref, Boolean newValue) {
+        if (DBG) log("saveLookupProviderSwitches()");
+
+        if (pref == mEnableForwardLookup) {
+            Settings.System.putInt(getContentResolver(),
+                    Settings.System.ENABLE_FORWARD_LOOKUP,
+                    newValue ? 1 : 0);
+        } else if (pref == mEnableReverseLookup) {
+            Settings.System.putInt(getContentResolver(),
+                    Settings.System.ENABLE_REVERSE_LOOKUP,
+                    newValue ? 1 : 0);
+        }
+    }
+
+    private void restoreLookupProviderSwitches() {
+        if (DBG) log("restoreLookupProviderSwitches()");
+
+        mEnableForwardLookup.setChecked(Settings.System.getInt(
+                getContentResolver(),
+                Settings.System.ENABLE_FORWARD_LOOKUP, 1) != 0 ? true : false);
+        mEnableReverseLookup.setChecked(Settings.System.getInt(
+                getContentResolver(),
+                Settings.System.ENABLE_REVERSE_LOOKUP, 1) != 0 ? true : false);
+    }
+
+    private void initLookupProviders() {
+        if (DBG) log("initLookupProviders()");
+
+        String[] fEntries = getApplicationContext().getResources()
+                .getStringArray(R.array.forward_lookup_provider_names);
+        String[] fEntryValues = getApplicationContext().getResources()
+                .getStringArray(R.array.forward_lookup_providers);
+
+        String[] rEntries = getApplicationContext().getResources()
+                .getStringArray(R.array.reverse_lookup_provider_names);
+        String[] rEntryValues = getApplicationContext().getResources()
+                .getStringArray(R.array.reverse_lookup_providers);
+
+        if (GooglePlayServicesUtil.isGooglePlayServicesAvailable(
+                getApplicationContext()) != ConnectionResult.SUCCESS) {
+            if (DBG) log("Google Play Services is NOT available");
+
+            List<String> listRNames = new ArrayList<String>(
+                    Arrays.asList(rEntries));
+            List<String> listRValues = new ArrayList<String>(
+                    Arrays.asList(rEntryValues));
+
+            int index = listRValues.indexOf("Google");
+
+            if (index != -1) {
+                if (DBG) log("Removing Google from the reverse lookup providers");
+
+                listRNames.remove(index);
+                listRValues.remove(index);
+            }
+
+            rEntries = listRNames.toArray(new String[0]);
+            rEntryValues = listRValues.toArray(new String[0]);
+        }
+
+        mChooseReverseLookupProvider.setEntries(rEntries);
+        mChooseReverseLookupProvider.setEntryValues(rEntryValues);
+
+        mChooseForwardLookupProvider.setEntries(fEntries);
+        mChooseForwardLookupProvider.setEntryValues(fEntryValues);
+    }
+
+    private void restoreLookupProviders() {
+        if (DBG) log("restoreLookupProviders()");
+
+        String fProvider = Settings.System.getString(
+                getContentResolver(),
+                Settings.System.FORWARD_LOOKUP_PROVIDER);
+
+        if (fProvider == null) {
+            mChooseForwardLookupProvider.setValueIndex(0);
+            saveLookupProviders(mChooseForwardLookupProvider,
+                    (String) mChooseForwardLookupProvider.getEntryValues()[0]);
+        } else {
+            mChooseForwardLookupProvider.setValue(fProvider);
+        }
+
+        String rProvider = Settings.System.getString(
+                getContentResolver(),
+                Settings.System.REVERSE_LOOKUP_PROVIDER);
+
+        if (rProvider == null) {
+            mChooseReverseLookupProvider.setValueIndex(0);
+            saveLookupProviders(mChooseReverseLookupProvider,
+                    (String) mChooseReverseLookupProvider.getEntryValues()[0]);
+        } else {
+            mChooseReverseLookupProvider.setValue(rProvider);
+        }
+    }
+
+    private void saveLookupProviders(Preference pref, String newValue) {
+        if (DBG) log("saveLookupProviders()");
+
+        if (pref == mChooseForwardLookupProvider) {
+            Settings.System.putString(
+                    getContentResolver(),
+                    Settings.System.FORWARD_LOOKUP_PROVIDER,
+                    newValue);
+        } else if (pref == mChooseReverseLookupProvider) {
+            Settings.System.putString(
+                    getContentResolver(),
+                    Settings.System.REVERSE_LOOKUP_PROVIDER,
+                    newValue);
+        }
+    }
+
     /**
      * Enumerates existing VM providers and puts their data into the list and populates
      * the preference list objects with their names.
-- 
1.8.5.4

