From 653c5ce2ab1766ba3f85fa6252030b6785144037 Mon Sep 17 00:00:00 2001
From: Xiao-Long Chen <chenxiaolong@cxl.epac.to>
Date: Mon, 30 Dec 2013 02:40:49 -0500
Subject: [PATCH] Re-add LoaderCallbacks to CyanogenMod dialer

Change-Id: Ie785e9a95b45cbc196f48763bd132d3f3218bd97
---
 src/com/android/dialer/CallDetailHeader.java | 44 ++++++++++++++++++++++++++++
 1 file changed, 44 insertions(+)

diff --git a/src/com/android/dialer/CallDetailHeader.java b/src/com/android/dialer/CallDetailHeader.java
index 8ad0379..0bbe9db 100644
--- a/src/com/android/dialer/CallDetailHeader.java
+++ b/src/com/android/dialer/CallDetailHeader.java
@@ -22,12 +22,14 @@ import android.content.Intent;
 import android.content.res.Resources;
 import android.graphics.drawable.Drawable;
 import android.net.Uri;
+import android.os.Bundle;
 import android.provider.Contacts.Intents.Insert;
 import android.provider.ContactsContract.CommonDataKinds.Phone;
 import android.provider.ContactsContract.Contacts;
 import android.telephony.PhoneNumberUtils;
 import android.telephony.TelephonyManager;
 import android.text.TextUtils;
+import android.util.Log;
 import android.view.ActionMode;
 import android.view.KeyEvent;
 import android.view.Menu;
@@ -47,12 +49,15 @@ import com.android.contacts.common.model.Contact;
 import com.android.contacts.common.model.ContactLoader;
 import com.android.contacts.common.format.FormatUtils;
 import com.android.contacts.common.util.Constants;
+import com.android.contacts.common.util.UriUtils;
 import com.android.dialer.calllog.PhoneNumberHelper;
 import com.android.dialer.calllog.PhoneNumberUtilsWrapper;
 
 import android.provider.ContactsContract.DisplayNameSources;
 
 public class CallDetailHeader {
+    private static final String TAG = "CallDetail";
+
     private static final int LOADER_ID = 0;
     private static final String BUNDLE_CONTACT_URI_EXTRA = "contact_uri_extra";
 
@@ -121,6 +126,37 @@ public class CallDetailHeader {
         }
     };
 
+    private final LoaderCallbacks<Contact> mLoaderCallbacks = new LoaderCallbacks<Contact>() {
+        @Override
+        public void onLoaderReset(Loader<Contact> loader) {
+        }
+
+        @Override
+        public void onLoadFinished(Loader<Contact> loader, Contact data) {
+            final Intent intent = new Intent(Intent.ACTION_INSERT_OR_EDIT);
+            intent.setType(Contacts.CONTENT_ITEM_TYPE);
+            if (data.getDisplayNameSource() >= DisplayNameSources.ORGANIZATION) {
+                intent.putExtra(android.provider.ContactsContract.Intents.Insert.NAME,
+                        data.getDisplayName());
+            }
+            intent.putExtra(android.provider.ContactsContract.Intents.Insert.DATA,
+                    data.getContentValues());
+            bindContactPhotoAction(intent, R.drawable.ic_add_contact_holo_dark,
+                    mResources.getString(R.string.description_add_contact));
+        }
+
+        @Override
+        public Loader<Contact> onCreateLoader(int id, Bundle args) {
+            final Uri contactUri = args.getParcelable(BUNDLE_CONTACT_URI_EXTRA);
+            if (contactUri == null) {
+                Log.wtf(TAG, "No contact lookup uri provided.");
+            }
+            return new ContactLoader((CallDetailActivity) mActivity, contactUri,
+                    false /* loadGroupMetaData */, false /* loadInvitableAccountTypes */,
+                    false /* postViewNotification */, true /* computeFormattedPhoneNumber */);
+        }
+    };
+
     public CallDetailHeader(Activity activity, PhoneNumberHelper phoneNumberHelper) {
         mActivity = activity;
         mResources = activity.getResources();
@@ -232,6 +268,14 @@ public class CallDetailHeader {
             mainActionIcon = R.drawable.ic_contacts_holo_dark;
             mainActionDescription =
                 mResources.getString(R.string.description_view_contact, nameOrNumber);
+        } else if (UriUtils.isEncodedContactUri(contactUri)) {
+            final Bundle bundle = new Bundle(1);
+            bundle.putParcelable(BUNDLE_CONTACT_URI_EXTRA, contactUri);
+            mActivity.getLoaderManager().initLoader(LOADER_ID, bundle, mLoaderCallbacks);
+            mainActionIntent = null;
+            mainActionIcon = R.drawable.ic_add_contact_holo_dark;
+            mainActionDescription = mResources.getString(R.string.description_add_contact);
+            skipBind = true;
         } else if (isVoicemailNumber) {
             mainActionIntent = null;
             mainActionIcon = 0;
-- 
1.8.5.2

